= How to integrate Kill Bill and Stripe end-to-end for a Monthly Subscription

== Introduction

Creating a recurring billing solution can be difficult, and there are many challenges in the way.  Customer management, automatic invoicing, secure payments, and failed transaction management are some common difficulties a business with a recurring subscription model may face.   

In addition, many existing SaaS solutions force vendor lock-in on their customers, meaning the entirety of data is not owned by you.  You are also limited by the features offered by the provider for your pricing schemes, as opposed to building your own.

Kill Bill solves these challenges by:
* Operating from an entirely Open Source model -- whether it runs locally or in the cloud, you own the subscription data, as opposed to being limited to the types of reports the SaaS solution provides
* Integrating with providers like Stripe for payments, which will cover PCI complexity while you own the recurring billing logic

In this tutorial, we will guide you step-by-step on how to integrate Kill Bill and Stripe end-to-end for a monthly subscription model.

=== Step 1: Install Docker

The recommended way of installing Docker and Docker Compose is via Docker's repositories, for ease of installation and upgrade tasks.

Select the appropriate instructions for your link:https://docs.docker.com/install/[preferred operating system].

=== Step 2:  Install Docker Compose

Select the appropriate instructions for your link:https://docs.docker.com/compose/install/[preferred operating system].

=== Step 3:  Create a docker-compose.yaml file

In a terminal, type the following:

[source, bash]
----
$ mkdir killbill
$ cd killbill
----

With your favorite text editor, create a `+docker-compose.yaml+` file and reflect the following:

[source,yaml]
----
version: '3.7'
volumes:
  db:
services:
  killbill:
    image: killbill/killbill:0.22.2
    ports:
      - "8080:8080"
    environment:
      - KILLBILL_DAO_URL=jdbc:mysql://db:3306/killbill
      - KILLBILL_DAO_USER=root
      - KILLBILL_DAO_PASSWORD=killbill
  kaui:
    image: killbill/kaui:2.0.1
    ports:
      - "9090:8080"
    environment:
      - KAUI_CONFIG_DAO_URL=jdbc:mysql://db:3306/kaui
      - KAUI_CONFIG_DAO_USER=root
      - KAUI_CONFIG_DAO_PASSWORD=killbill
      - KAUI_KILLBILL_URL=http://killbill:8080
  db:
    image: killbill/mariadb:0.22
    volumes:
      - type: volume
        source: db
        target: /var/lib/mysql
    expose:
      - "3306"
    environment:
      - MYSQL_ROOT_PASSWORD=killbill
----

Note that you may have to change the link:https://docs.docker.com/compose/compose-file/compose-versioning/[version] of the yaml file you create, according to which version of Docker you are using.

Save the file, and run:

[source,bash]
----
$ docker-compose up
----

The startup sequence lasts a couple of minutes.  You should see something like the following once it finishes:

image:https://raw.githubusercontent.com/annabaker/killbill-docs/v3/userguide/assets/img/tutorials/stripe_integration_docker_startup.png[align=center]

If it takes a long time or if the container crashes, verify you have enough memory allocated to Docker. On a Mac for instance, go to Docker Desktop Preferences and set the Memory to 4GiB in the Advanced panel.

You may now access the following:

.Kaui UI
- http://127.0.0.1:9090 (username/password: admin/password)

.Kill Bill API
- http://127.0.0.1:8080

=== Step 4:  Add a new tenant 

Now, we need to add a new tenant.  

1.  At the top of the navigation panel, hover over the gear icon and select 'TENANTS.'

2.  Select the '+' icon next to Kaui Tenants.

.Enter the following information for the purpose of this tutorial:
- Name: bob
- API Key: bob
- API Secret: lazar

=== Step 5:  Create a new Sports product

After creating a new tenant, you should be brought to the following screen:

image:https://raw.githubusercontent.com/annabaker/killbill-docs/v3/userguide/assets/img/tutorials/stripe_integration_tenant.png[align=center]

At the bottom of the screen, select the '+' icon next to Existing Plans to create a new product.

For the purpose of this tutorial, enter the following:

image:https://raw.githubusercontent.com/annabaker/killbill-docs/v3/userguide/assets/img/tutorials/stripe_integration_new_product.png[align=center]

Click 'Save' and you should see the following:



=== Step 5:  Create a Stripe account

Create an account at https://www.stripe.com.  Once you have logged in, give your account a name by clicking on "Add a name" under the Unnamed account drop-down in the upper left-hand corner.  A name is required for the Stripe integration.

Next, in the left panel, navigate to Developers > API Keys and click on "Reveal test key token."  You will need these keys once we configure the Stripe plugin for Kill Bill.

=== Step 6:  Install the Stripe Plugin

In Kaui, hover over the plug icon at the top of the page and click on 'KPM (Kill Bill Plugin Manager).'  

Select "Install New Plugin" in the upper-right corner.

In the list of plugins, fnd "stripe" and click on the cloud button to install.

After a few moments, refresh the `+/kpm+` page.  You should see the stripe-plugin listed with a status of 'STOPPED.'  Click the play button to start it.  If you refresh again, you should find the stripe-plugin listed with a status of 'RUNNING.'

<image>

=== Step 7:  Configure the Stripe Plugin with your API Keys

In Kaui, at the top of the screen, hover over the gear icon and select 'TEnANTS.'

Click 'bob.'

At the bottom of the screen, navigate to the tab labeled 'Plugin Config.'

For Plugin name, select "stripe" from the drop-down menu.

In the confiuration, enter the following and paste your publishable and secret keys you obtained from Stripe in Step 5.

[source,java]
----
org.killbill.billing.plugin.stripe.apiKey=sk_test_XXXX
org.killbill.billing.plugin.stripe.publicKey=pk_test_XXXX
----

=== Step 8:  
