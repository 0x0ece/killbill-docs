= Debugging tips

== Healthchecks and metrics

Kill Bill exposes both healthchecks and metrics. These can be accessed via:

```
curl -v http://<IP_ADDRESS>:8080/1.0/healthcheck?pretty=true
curl -v http://<IP_ADDRESS>:8080/1.0/metrics?pretty=true
```

== Remote debugging

Specify `-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=12345` on startup in your JVM settings to enable remote debugging (this is set by default in our Docker images). You can then connect to Kill Bill on port 12345 from your debugger (e.g. Eclipse or IntelliJ).

If Kill Bill is running locally, you can just specify `localhost` or `127.0.0.1` as the remote host in your debugger. To debug instances remotely (e.g. in the cloud), you need to specify the publicly accessible IP address of your instance. For Docker, this should be the public IP address of the container. If you are using docker-machine and your machine is named `default`, you can retrieve the IP address via `docker-machine inspect default -f '{{.Driver.IPAddress}}'`.

Make sure also that the port `12345` is open (e.g. check your security groups in AWS). For Docker, expose the port via `-p12345:12345`.

== Turning on DEBUG logging

Specify `-Dcom.sun.management.jmxremote=true -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.port=8000 -Dcom.sun.management.jmxremote.rmi.port=8000 -Dcom.sun.management.jmxremote.ssl=false -Djava.rmi.server.hostname=localhost` on startup in your JVM settings to enable access via `jconsole`.

You can set at runtime the log level of specific classes and packages (look for  the `ch.qos.logback.classic:Name=default,Type=ch.qos.logback.classic.jmx.JMXConfigurator` MBean).

Similar considerations as the remote debugging section apply regarding the IP address and expose ports (see above).

== Following tokens

To understand why a specific action was taken, it is often useful to follow tokens.

When invoking a JAX-RS (HTTP) API, a `userToken` is automatically generated. You can also specify your own token via the `X-Request-Id` HTTP header (it *must* be a UUID).

Once set, this token is:

* attached to the processing thread
* attached to SLF4J MDC context as `kb.userToken` and displayed by default in logs (`tok=`)
* passed to all APIs as `CallContext#getUserToken()`
* passed to internal bus events as `BusEvent#getUserToken()`
* passed to external bus events as `ExtBusEvent#getUserToken()`
* passed to future notifications as `userToken`

Note that when a notification is created, a `futureUserToken` is auto-generated. That `futureUserToken` becomes the `userToken` when the notification is dispatched.

You can search for these tokens in Kaui, on the _Queues_ screen, accessible from the tenant page or via the per-account sub-menu (you need to be logged-in as the Kaui root user).

=== Testing changes over time

We have a clock abstraction in Kill Bill that can be manipulated through an API, as long as you start Kill Bill with `org.killbill.server.test.mode=true` (`-e KILLBILL_SERVER_TEST_MODE=true` in Docker):

[source,bash]
----
curl -v \
     -u admin:password \
     -H "X-Killbill-ApiKey: bob" \
     -H 'X-Killbill-ApiSecret: lazar' \
     -H 'X-Killbill-CreatedBy: admin' \
     "http://127.0.0.1:8080/1.0/kb/test/clock"

curl -v \
     -u admin:password \
     -H "X-Killbill-ApiKey: bob" \
     -H 'X-Killbill-ApiSecret: lazar' \
     -H 'X-Killbill-CreatedBy: admin' \
     -H "Accept: application/json" \
     -X POST \
     "http://127.0.0.1:8080/1.0/kb/test/clock?requestedDate=2015-12-14T23:02:15.000Z"

curl -v \
     -u admin:password \
     -H "X-Killbill-ApiKey: bob" \
     -H 'X-Killbill-ApiSecret: lazar' \
     -H 'X-Killbill-CreatedBy: admin' \
     -H "Accept: application/json" \
     -X PUT \
     "http://127.0.0.1:8080/1.0/kb/test/clock?days=10"
----

Here is an https://github.com/killbill/killbill-integration-tests/blob/165b76b5864fb40f1a5774f64c145d56123a5e62/killbill-integration-tests/mixin-utils/helper.rb#L131-L145[example] how it could be used in tests.

== Docker and Ansible

Our Docker images use Ansible behind the scenes to install and configure Kill Bill in the container. The actual Ansible commands run are available in the images via the environment variables `$KPM_INSTALL_CMD` and `$START_TOMCAT_CMD`.

If you need to debug this setup process, you can start a container via `docker run -ti killbill/killbill:0.20.0 bash` and execute these commands manually.

== Seeking help

If all else fail, reach out to our https://groups.google.com/forum/#!forum/killbilling-users[mailing-list] for help (*do not open a Github issue*).

In your message, specify:

* What you are seeing and what you are expecting
* How to reproduce your scenario (cURL commands, code snippet, ...)
* https://github.com/killbill/killbill-cloud[KPM] diagnostic output, e.g.

```
kpm diagnostic --killbill-api-credentials=bob lazar \
               --killbill-credentials=admin password \
               --killbill-url=http://127.0.0.1:8080 \
               --killbill-web-path=/var/lib/tomcat7/webapps/ROOT/ \
               --kaui-web-path=/var/lib/tomcat7/webapps/ROOT/ \
               --log-dir=/var/lib/tomcat7/logs \
               --account_export=ACCOUNT_ID
```
