= Installation via Single AMI

== Overview

Single AMI deployments are a way to deploy the Kill Bill stack, that is both the Kill Bill server and the administrative UI (KAUI), from one AMI. We offer two options. The `Single-Tier` option uses only a single EC2 instance. This is suitable for testing and experiments. The `Multi-Tier` option uses two or more EC2 instances, and is designed for production deployments. Both of these deployment options rely on the same underlying AMI, but for the `Multi-Tier` option there is a list of prerequisites, such as an external database, along with a startup script to be provided when launching the instance.


== Single-Tier Deployments

The single-tier deployment option is designed to get you started as quickly as possible. Everything you need: Kill Bill, KAUI, and the MariaDB (MySQL) database, is bundled in the AMI and can be launched on a single EC2 instance with just one click. This makes it very suitable for test environments, but we don't recommend it for production deployments.

The AMI also comes with a running instance of the load balancer `nginx` that acts as a reverse proxy and spreads the incoming traffic to either Kill Bill or KAUI based on the incoming port. The EC2 instance will be an instance of Ubuntu Linux. The organization of the single-tier system looks like this:

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/single-tier-ami_deployment.png[align=center]

In this model, the Kill Bill server and KAUI are deployed within the `tomcat` application server. Requests are handled by `nginx`. Requests received on port 443 are delivered to KAUI, and those received on port 8443 are delivered to Kill Bill. Both Kill Bill and KAUI communicate as needed with the `mysql` database.  

=== Getting Started


To start the installation process, point your browser to +++<a href="https://aws.amazon.com/marketplace/pp/B083LYVG9H?ref=_ptnr_doc_" onclick="getOutboundLink('https://aws.amazon.com/marketplace/pp/B083LYVG9H?ref=_ptnr_doc_'); return false;">AWS Marketplace</a>+++: 

If you are new to AWS, you will be asked to create an account and provide billing information. Once your account is validated,
you should see the following image at the top of your screen:

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/single-ami-subscribe.png[align=center]

Click *Continue to Subscribe*. The next page will give the AWS Terms and Conditions:

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/single-ami-terms-ask.png[align=center]

Accept the terms if asked. You will then see a new message confirming that you have subscribed. Next, click **Continue to Configuration**.

The next page will give several configuration options. 

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/single-ami-configure.png[align=center]

In most cases you should accept the defaults. Then click **Continue to Launch**.

The next page will give you several options for the launch method. We recommend that you choose **Launch through EC2**.

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/single-ami-launch.png[align=center]

All other options will disappear. Click **Launch**.

The next page is titled **Choose Instance Type**. Your instance type is already chosen, so click **Review and Launch** at the bottom of the page.

The following page is headed **Review Instance Launch**. This provides a chance to review the details of your chosen instance. Then click **Launch** at the bottom of the page.

Next you will see a very important popup that asks you to choose or create a **key pair**.

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/single-ami-keypair.png[align=center]

The key pair provides the credentials you will need to login to your EC2 instance. For details about key pairs, see the https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html[AWS documentation]. We recommend that you create a new key pair. Give the key pair a simple, easy to remember name such as `My-Key-Pair`. Then click **Download Key Pair**. Important: You *must* save the private key that will be generated in this step. If you lose this key, you will *not* be able to login to your instance.

When the key pair is generated, click **Launch Instances**. You should see the screen below:

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/single-ami-launching.png[align=center]

Your instance is finally launching! To follow what is happening on the EC2 Dashboard, scroll all the way down to the bottom, and click **View Instance** at the bottom right. This will take you to the `Instances` screen which is part of the EC2 Dashboard.

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/single-ami-instances.png[align=center]


In a short time, the **Instance State** for your instance should indicate `Running`. You will need to scroll to the right to see all of the information available about your instance.

You are almost set, but there is one more thing you should do, and that is to scroll down in the menu on the left side to select **Security Groups**. You should see a list of two or more groups. Select the group whose name begins with `Kill Bill on AWS`, then scroll to the bottom and select the tab for `Inbound Rules`. You should see:

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/single-ami-inbound.png[align=center]

These rules enable the ports that must be open to access KAUI and Kill Bill from a browser. To enable direct login to your instance using SSH, you need to add one more port. Click on **Edit Inbound Rules**. Then add a rule with the following elements: Type: SSH, Protocol: TCP, Port Range: 22, Source: 0.0.0.0/0. Your Inbound Rules should now look like this:  

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/single-ami-inbound-new.png[align=center]

=== Initial Testing

You can now login to KAUI from your browser using the URL https://INSTANCE_IP:443, where INSTANCE_IP is the IPV4 address for your instance, given on your dashboard as **Public IPV4 Address**. This should display the KAUI login screen. The default credentials are: *admin/password*. The first few requests might be a bit slow as Kill Bill initializes itself.

For an introduction to KAUI, see our http://docs.killbill.io/latest/getting_started.html#_using_kill_bill_with_kaui[Getting Started] guide.

You can also login in directly to your instance from a terminal or command window. You may have no need to do this for a while, but you should try it and make sure it works. You may need to do this for system monitoring or troubleshooting later.

To login, use the secure shell command:

`ssh -i PRIVATE_KEY.pem ubuntu@INSTANCE_IP`

Here PRIVATE_KEY is the pathname where you have stored the private key that was downloaded when you generated your key pair, and INSTANCE_IP is the IPV4 address described earlier. The private key will not work unless its access controls are set to readable by the owner only.

On Windows versions before Windows 10, you may need to download a program called PuTTY to enable `ssh`. On Windows 10 `ssh` is available but may need to be activated through the Settings screen.

The first time you login, you will see a warning message asking if you want to add this host to your list of hosts. You should answer `yes`.

For more information about the organization of your instance, see the Configuration and Troubleshooting sections below. To exit from your login, type `exit`.


== Multi-Tier Deployments

=== Overview

For production deployments, we recommend a *multi-tier* configuration with two or more EC2 instances and a separate database instance using the `Amazon Relational Database Service (RDS)`. In place of `nginx`, this configuration relies on an AWS `Elastic Load Balancer (ELB)` to correctly spread the traffic among the various nodes, and also to route traffic to either  Kill Server or KAUI based on the incoming port. This deployment option requires a bit more setup, so we also provide an (easier) way to deploy using https://docs.killbill.io/latest//aws-cf.html[CloudFormation templates]. However, the multi-tier option provides more control over the deployment.

The diagram below illustrates the multitier configuration. This section will explain how to setup this option.

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/multi-tier-ami_deployment.png[align=center]

=== Login to AWS

To begin, log in to Amazon Web Services at https://aws.amazon.com. If you are new to AWS, you will be asked to create an account and provide billing information. You will need to sign in as a *Root User*. This should take you to the *AWS Management Console*, which provides links to all available services.

Check the upper right corner of your screen to be sure you are in the appropriate *Region*. All resources you create will be placed in this region, and may not be accessible from other regions.

=== Setup the Database

Once you are logged in, the first step is to setup the RDS instance. This process begins with the RDS dashboard, which should be available from the Services menu. When the dashboard appears, select `Databases` from the left menu, and click the red button at the top right that reads `Create Database`:

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/multitier-create-database.png[align=center]

You will be taken to the `Create Database` page. The first choice you will have is between `Standard Create`, which allows you to set a full range of configuration parameters, or `Easy Create`, which sets most of these parameters to defaults. We recommend `Easy Create` in most cases.

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/multitier-standard-or-easy.png[align=center]

The next section offers you a choice of several database types. Kill Bill can work with any database type that is `mysql` or `postgres` compatible. For robust production use, Amazon Aurora is probably a good choice. Here we will illustrate the simpler steps setting up a MariaDB database.

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/multitier-database-types.png[align=center]

The next choice determines the instance size. We suggest the `Production` option as this will provide the most robust configuration.

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/multitier-instance-sizes.png[align=center]

The last section asks you to:

1. Specify a name for your database
2. Give a username for the administrative account (we suggest that you do *not* use the default name)
3. Provide a password for the administrative acount (we suggest you let AWS generate one for you)

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/multitier-names-and-password.png[align=center]

When the password is setup and confirmed, click `Create Database` in the lower right corner. You will return to the main Databases screen, which should now look like this:

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/multitier-database-starting.png[align=center]

This display shows that your database is starting. After a few minutes, the status will change to `Available` (You may need to reload the page to see this). At this time you can click on the database name to get more information, including the full name of the instance.

On the page that appears you should see a panel named `Connectivity and Security`. The left side of this panel shows the full name of the endpoint, which you will need shortly, and the port number, which is normally 3306.

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/multitier-connectivity-and-security.png[align=center]

Lastly, on the `Connectivity and Security` panel, locate and click on the link for the default VPC security group. You will need to add an inbound security rule, because the database by default does not allow external access. In the panel for this group, click on `Inbound Rules` and select `Edit Inbound Rules`. Next click on `Add rule`. In the `Type` column select `MYSQL/Aurora`. The port will be set to 3306 automatically. In the `Source` column, click on the search icon and select `0.0.0.0/0`. Finally, click on `Save Rules` in the bottom right. Your database is ready to go.

=== Edit the Configuration Script

To set up the EC2 instances you will need to provide them with information needed to connect to the databases. We provide a brief configuration script to simplify this process. The template for this script is as follows:


```
#!/bin/bash

DB_PROPS="/var/tmp/db.props.$$"
KB_PROPS="/var/tmp/kb.props.$$"

cat <<_EOF > $DB_PROPS
#
# EDIT THE FOLLOWING DB PROPERTIES AS NEEDED:
#
DB_SERVER=DB-INSTANCE-NAME:3306
DB_USER=ADMIN-NAME
DB_PASSWORD=PASSWORD
KILLBILL_DB_NAME=killbill
KAUI_DB_NAME=kaui
_EOF

cat <<_EOF > $KB_PROPS
#
# EDIT THE FOLLOWING KB PROPERTIES AS NEEDED:
#
org.killbill.dontexist=foo
_EOF

su -l -c "cd /var/lib/tomcat/bin && /var/lib/tomcat/bin/updateProperties.sh $DB_PROPS $KB_PROPS" tomcat
```
First, you need to edit the database properties. DB_SERVER should be set to the full name of the DB instance, as given in the `Connectivity and Security` panel (see above). THe port number 3306 is required. DB_USER and DB_PASSWORD should be set to the administrator credentials you have chosen for the RDS instance.

Second, you may optionally edit any Kill Bill properties that you need to change from the standard defaults.

=== Launch the EC2 Instances

The next step is to launch the number of EC2 instances you want, all based on the Kill Bill single AMI.


To start the installation process, point your browser to +++<a href="https://aws.amazon.com/marketplace/pp/B083LYVG9H?ref=_ptnr_doc_" onclick="getOutboundLink('https://aws.amazon.com/marketplace/pp/B083LYVG9H?ref=_ptnr_doc_'); return false;">AWS Marketplace</a>+++: 

You should see the following image at the top of your screen:

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/multitier-subscribe.png[align=center]

Click *Continue to Subscribe*. The next page will give the AWS Terms and Conditions:

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/multitier-terms-ask.png[align=center]

Accept the terms if asked. You will then see a new message confirming that you have subscribed. Next, click **Continue to Configuration**.

The next page will give several configuration options. 

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/multitier-configure.png[align=center]

In most cases you should accept the defaults. Then click **Continue to Launch**.

The next page will give you several options for the launch method. We recommend that you choose **Launch through EC2**.

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/multitier-launch.png[align=center]

All other options will disappear. Click **Launch**.

The next page is titled **Choose Instance Type**. Your instance type is already chosen, so click **Configure Instance Details** at the bottom of the page.

The next page will provide you with a long list of options. The first option is **Number of Instances**. Set the number of instances you wish to launch. Each instance will have essentially the same configuration, including the same image and the same security group.

After setting the number of instances, scroll down to the bottom of the page. The last section is titled **Advanced Settings**. In this section you should set the configuration file you produced above. The setting panel should look like this:

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/multitier-userdata.png[align=center]

Now click *Review and Launch* at the bottom of the page. The following page is headed **Review Instance Launch**. This provides a chance to review the details of your chosen instances. Then click **Launch** at the bottom of the page.

Next you will see a very important popup that asks you to choose or create a **key pair**.

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/multitier-keypair.png[align=center]

The key pair provides the credentials you will need to login to your EC2 instances. For details about key pairs, see the https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html[AWS documentation]. We recommend that you create a new key pair. All your instances can use the same one. Give the key pair a simple, easy to remember name such as `My-Key-Pair`. Then click **Download Key Pair**. Important: You *must* save the private key that will be generated in this step. If you lose this key, you will *not* be able to login to your instances.

When the key pair is generated, click **Launch Instances**. You should see the screen below:

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/multitier-launching.png[align=center]

Your instances are finally launching! To follow what is happening on the EC2 Dashboard, scroll all the way down to the bottom, and click **View Instance** at the bottom right. This will take you to the `Instances` screen which is part of the EC2 Dashboard.

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/multitier-instances.png[align=center]


In a short time, the **Instance State** for your instance should indicate `Running`. You will need to scroll to the right to see all of the information available about your instances.

=== Setup Security Rules

You are almost set, but there is one more thing you need to do, and that is to scroll down in the menu on the left side to select **Security Groups**. You should see a list of two or more groups. Select the group whose name begins with `Kill Bill on AWS`, then scroll to the bottom and select the tab for `Inbound Rules`. You should see:

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/multitier-inbound-original.png[align=center]

These rules enable the ports that must be open to access KAUI and Kill Bill from a browser. However, for access through the ELB these ports will be different. In addition, to enable direct login to your instance using SSH, you need to add one more port.

Click on **Edit Inbound Rules**. then do the following:

1. For the rule that specifies Type: HTTPS, Port Range: 443, change the type to CUStOM TCP and the Port Range to 3000.
2. For the rule that specifies Type: CUStOM TCP, Port Range: 8443, change the Port Range to 8080.
3. Finally, add a rule with the following elements: Type: SSH, Protocol: TCP, Port Range: 22, Source: 0.0.0.0/0.

Your Inbound Rules should now look like this:  

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/multitier-inbound-new.png[align=center]

You should now be able to login to KAUI from your browser using the URL https://INSTANCE_IP:3000, where INSTANCE_IP is the IPV4 address for any one of your instances, given on your dashboard as **Public IPV4 Address**. This should display the KAUI login screen. The default credentials are: *admin/password*. The first few requests might be a bit slow as Kill Bill initializes itself. For an introduction to KAUI, see our http://docs.killbill.io/latest/getting_started.html#_using_kill_bill_with_kaui[Getting Started] guide.

In addition, the URL https://INSTANCE_IP:8080 should display a page confirming that the Kill Bill server is accessible.


=== Create the Databases

Kill Bill requires two databases, with the names `killbill` and `kaui`. We provide predefined schemas for these databases.

To create the databases, you will need to login to *one* of your instances. To login, use the secure shell command:

`ssh -i PRIVATE_KEY.pem ubuntu@INSTANCE_IP`

Here PRIVATE_KEY is the pathname where you have stored the private key that was downloaded when you generated your key pair, and INSTANCE_IP is the IPV4 address described earlier. *The private key will not work unless its access controls are set to readable by the owner only*.  The `ssh` command relies on the security rule providing access to Port 22, which you added in the previous step.

On Windows versions before Windows 10, you may need to download a program called PuTTY to enable `ssh`. On Windows 10 `ssh` is available but may need to be activated through the Settings screen.

The first time you login, you will see a warning message asking if you want to add this host to your list of hosts. You should answer `yes`.


Once you are logged in, you can use the `mysql` command to create the two databases `killbill` and `kaui`. The credentials for this command are the same ones you set up for the database and copied to the configuration file. Note that the DB-INSTANCE-NAME should *not* include the port number. 

The password will not be echoed when it is typed.

```
> mysql -h DB-INSTANCE-NAME -u ADMIN-NAME -p
Enter Password: 
mysql> create database killbill;
mysql> create database kaui;
mysql> exit
```
The next step is to install the schemas. These can be found at:

* killbill schema: `http://docs.killbill.io/latest/ddl.sql`
* kaui schema: `https://github.com/killbill/killbill-admin-ui/blob/master/db/ddl.sql`

One easy way to do this is to return to your local computer (type `exit`) and use the `sftp` command. Then upload them to your EC2 instance home directory with the commands:

```
sftp -i PRIVATE_KEY.pem ubuntu@INSTANCE_IP
put killbill.ddl
put kaui.ddl
exit
```

Once the files are successfully uploaded, login again to your instance using the `ssh` command. You can now install the schemas:

```
> mysql -h DB-INSTANCE-NAME -u ADMIN-NAME -p killbill < killbill.ddl
Enter Password:
> mysql -h DB-INSTANCE-NAME -u ADMIN-NAME -p kaui < kaui.ddl
Enter Password:
```
To ensure that the databases are setup correctly, login to `mysql` again, then try the SHOW TABLES command:

```
> mysql -h DB-INSTANCE-NAME -u ADMIN-NAME -p
Enter Password:
use killbill
show tables;
use kaui
show tables;
exit
```

Each `show tables` command should display a list of table names for the database. 




=== Add the ELB in front of the EC2 instances

The last major task is to setup the Elastic Load Balancer in front of the EC2 instances. You will actually need to deploy two separate load balancers, one for access to KAUI, and one for the KB server.

To begin, from the EC2 dashboard scroll down the left-hand menu and select *Load Balancing / Load Balancers*. Then click the  *Create Load Balancer* button at the upper left.

You will be given a choice of several load balancer types. The type we will use is *Application Load Balancer*.

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/ELB-select-type.png[align=center]

Click on the *Create* button in the Application Load Balancer box. This will bring up the page titled *Step 1: Configure Load Balancer*:

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/ELB-basic-configuration.png[align=center]

On this page you need to do three things:

1. Assign a name to you load balancer
2. Select a protocol for your listener. For our first example we will assume this will be HTTP. However to ensure a secure connection, we recommend using HTTPS as discussed below.
3. Scroll to the bottom and select at least *two* availability zones. *IMPORTANT: You must select all of the zones that your EC2 instances are contained in. Otherwise, the load balancer will be unable to connect to these instances.*

Then choose *Next: Configure Security Settings*. You will now see a page titled *Step 2: Configure Security Settings*.

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/ELB-configure-security.png[align=center]

If you have selected the HTTPS protocol, you will now be required to create or provide an X.509 SSL Certificate. There are many ways to do this. Some are discussed below. If you are using HTTP, you will see a warning message. Ignore the message and choosed *Next: Configure Security Groups*. This will take you to a page titled *Step 3: Configure Security Groups.* 

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/ELB-configure-security-groups.png[align=center]

This page will show you the existing security groups and offer the choice to choose an existing group or create a new one. We advise you to create a new group at this time. The new security group should have inbound rules enabling inputs for KAUI and Kill Bill as follows: 

image:https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/ELB-security-group.png[align=center]

You will use the same security group for both load balancers.





== Configuration

=== SSL Certificates

We have configured `nginx` to listen to port `443` (and forward traffic to KAUI). By default, accessing the service from a web browser will show a `Not Secure` site. In order to make the site secure, you will need to add a valid certificate. The easiest option to add the certificate is to rely on `Let’s Encrypt`, a Certificate Authority (CA) that provides an easy way to obtain and install free TLS/SSL certificates.

The steps to add the certifcate are fairly simple and rely on a tool called `certbot`.

[1]. Verify `certbot` is installed or install it

Our latest image should include `certbot` by default, but if not this can be added using the following:

```
# Install certbot if not already present
sudo add-apt-repository -y ppa:certbot/certbot
sudo apt install -y python-certbot-nginx
```

[2]. Stop all services

`certbot` will need to have access to port `80` and `443`

```
# Stop kaui
> sudo service kaui stop
# Stop killbill
> sudo service killbill stop
# Stop nginx
> sudo service nginx stop
```

Make sure your AWS security groups allow incoming traffic on port `80` and port `443` for all IPs 

[3]. Setup your domain’s CNAME Record to point to the public DNS of your EC2 instance.

Create a `CNAME` to map your public DNS -- e.g `https://ec2-18-234-168-57.compute-1.amazonaws.com` -- to a legit `CNAME`, otherwise `certbot` will fail with the following error: `Error creating new order :: Cannot issue for "ec2-18-234-168-57.compute-1.amazonaws.com": The ACME server refuses to issue a certificate for this domain name, because it is forbidden by policy`

The configuration of your CNAME needs to happen from the UI of your domain provider (`Namecheap`, `Cloudflare`, ...)

[4]. Modify the nginx `killbill.conf` server sections

The `server_name` by default specifies `_`. Instead you need to replace this with your `CNAME`:

```
server {
    listen 443;
    server_name <CNAME>;

...
```

[5]. Run `certbot`

```
> sudo certbot --nginx -d <CNAME>
```

If successful you will see a message like:


```
...
IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at:
   /etc/letsencrypt/live/deployment.killbill.io/fullchain.pem
   Your key file has been saved at:
   /etc/letsencrypt/live/deployment.killbill.io/privkey.pem
   Your cert will expire on 2020-05-11. To obtain a new or tweaked
   version of this certificate in the future, simply run certbot again
   with the "certonly" option. To non-interactively renew *all* of
   your certificates, run "certbot renew"
 - If you like Certbot, please consider supporting our work by:

   Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
   Donating to EFF:                    https://eff.org/donate-le
```

[6]. Restart all services

```
# Start nginx
> sudo service nginx start
# Start killbill
> sudo service killbill start
# Start kaui
> sudo service kaui start
```

Note: You can edit your security groups and remove the `port` `80`, and also reduce the visibility for other ports by specifying a tighter range of incoming IPs.

The `Let's Encrypt` certifcates are only valid 90 days and will therefore neeed to be renewed. `certbot` will create a cron entry under `/etc/cron.d/certbot` to make this process transparent.

=== Kill Bill

Kill Bill global properties are defined in `/var/lib/killbill/config/killbill.properties`. For example, this is where you can change the MySQL credentials. Take a look at our https://docs.killbill.io/latest/userguide_configuration.html[configuration guide] for more details.

This is also where you can change the default Kill Bill admin credentials: specify `org.killbill.security.shiroResourcePath=/var/lib/killbill/config/shiro.ini` and create the `shiro.ini` file accordingly (see our https://docs.killbill.io/latest/user_management.html[RBAC guide] for more details).

== TroubleShooting Section


After launching the EC2 instance, the full stack should come up, with all services enabled and running, that is:

* An nginx instance receiving traffic on port `443` and `8443`
* A instance of Kill Bill server listening on `127.0.0.1:8080` (and receiving external traffic through nginx on port `8443`)
* A instance of Kaui listening on `127.0.0.1:3000` (and receiving external traffic through nginx on port `443`)
* A local `mysql` server running on port `3306`

In this section, we will provide some tips to verify the health of the system, and what to do when things are not working

**SSH to EC2 Instances**

From the EC2 dashboard, in the instance `Description` tab, you can copy the public DNS, called `Public DNS (IPv4)`.
Then, using the private key you specified when creating the instance:

```
# SSH as ubuntu user
> ssh -i  <LOCATION_KEY>/<KEY_NAME>.pem ubuntu@<PUBLIC_DNS>
# Move to tomcat user
> sudo su - tomcat
```

**Service Health**

All services are started using System V init scripts, and so the status of the service can be retrieved:

* Kill Bill server: `service killbill status`
* KAUI server: `service kaui status`
* Nginx server: `service nginx status`

Similarly one can `start`, `stop` the services using simalar command -- e.g `service kaui stop` to stop KAUI.

In order to verify the health of the Kill Bill server instance, you can issue the following commands:

* Healthcheck endpoint: `curl http://127.0.0.1:8080/1.0/healthcheck`
* System info: `curl -u admin:password http://127.0.0.1:8080/1.0/kb/nodesInfo`

**Log Files**

Tomcat logs are under `/var/lib/tomcat/logs/`:

* KAUI logs: `/var/lib/tomcat/logs/kaui.out`
* Kill Bill server logs: `/var/lib/tomcat/logs/catalina.out`

Nginx logs can be found under `/var/log/nginx/`

* Access logs: `/var/log/nginx/access.log`
* Error logs: `/var/log/nginx/error.log`

**System Diagnostics**

In order to get some support, the first thing we would require is some information about your deployment. We have created a `diagnostic` command for that effect:

```
# Login as 'tomcat'
> sudo su - tomcat
#
# Assume a 'bob/lazar' tenant
# Assume some credentials 'admin/password'
#
> kpm  diagnostic \
  --killbill-credentials=admin password \
  --bundles-dir=/var/lib/killbill/bundles \
  --database-name=killbill \
  --database-credentials=root root \
  --killbill-api-credentials=bob lazar \
  --kaui-web-path=/var/lib/tomcat/webapps2 \
  --killbill-url=http://127.0.0.1:8080 \
  --database-host=127.0.0.1:3306

...
Diagnostic data exported under /tmp/killbill-diagnostics-20200213-23204-u93ah5/killbill-diagnostics-02-13-20.zip 
```

**Database**

In order to access the database, one can use the following command  `mysql -u root -proot`. There is one `killbill` and one `kaui` database created and used by the respective application


**Nginx**

The configuration files are located under `/etc/nginx/` -- e.g `/etc/nginx/sites-enabled/killbill.conf`

== Upgrade steps

Note: you must switch to the `tomcat` user first in order to upgrade Kill Bill or Kaui (`sudo su - tomcat`).

The configuration file `/var/lib/killbill/kpm.yml` specifies the Kill Bill version (and its plugins) running on the instance. After updating this file with the new version(s), simply execute `$KPM_INSTALL_KB_CMD`, delete the cached directory `/var/lib/tomcat/webapps/ROOT` and restart the instance.

A similar process can be used for Kaui: update `/var/lib/kaui/kpm.yml`, run `$KPM_INSTALL_KAUI_CMD`, delete the cached directory `/var/lib/tomcat/webapps2/ROOT` and restart the instance.
